import streamlit as st
import pandas as pd
import json
import plotly.graph_objects as go
from datetime import datetime
import os

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="Hojun Lee | Master Dashboard",
    page_icon="ğŸš€",
    layout="wide"
)

# --- 1. ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜ & ë³´ì•ˆ ì„¤ì • ---
st.sidebar.title("ğŸŒŸ Hojun's Master Dashboard")

# URL íŒŒë¼ë¯¸í„° í™•ì¸ (?view=admin ì¼ ë•Œë§Œ ê²½ë ¥ ë©”ë‰´ í‘œì‹œ)
query_params = st.query_params
is_admin = query_params.get("view") == "admin"

menu_options = ["ğŸ“Š ì‚¼ì„±ë°”ì´ì˜¤ ì‹¤ì  ë¶„ì„", "ğŸ”¬ AI ê°€ìƒ ì—°êµ¬ì†Œ ë™í–¥"]
if is_admin:
    menu_options.append("ğŸ“‚ ê²½ë ¥ ëª¨ë‹ˆí„°ë§ (ë¹„ë°€)")

page = st.sidebar.selectbox("ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”", menu_options)

st.sidebar.markdown("---")
st.sidebar.subheader("ğŸŒ ì¹œêµ¬ë“¤ì—ê²Œ ê³µìœ í•˜ê¸°")
st.sidebar.info("""
1. í˜„ì¬ ë³´ê³  ê³„ì‹  ì›¹ ë¸Œë¼ìš°ì €ì˜ **URL ì£¼ì†Œë¥¼ ë³µì‚¬**í•˜ì—¬ ë³´ë‚´ì£¼ì„¸ìš”.
2. ì¹œêµ¬ë“¤ì€ 'ì‹¤ì  ë¶„ì„'ê³¼ 'AI ì—°êµ¬ ë™í–¥'ë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
""")

# --- 2. í˜ì´ì§€ë³„ í•¨ìˆ˜ ì •ì˜ ---

def show_samsung_page():
    st.title("ğŸš€ ì‚¼ì„±ë°”ì´ì˜¤ ì‹¤ì  ë¶„ì„ ëŒ€ì‹œë³´ë“œ")
    DATA_FILE = "samsung_historical_data.json"
    
    if not os.path.exists(DATA_FILE):
        st.error("ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    with open(DATA_FILE, "r", encoding="utf-8") as f:
        data = json.load(f)

    # ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤ ì„¹ì…˜
    st.header("ğŸ¢ ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤ (Samsung Biologics)")
    biologics_df = pd.DataFrame(data["SamsungBiologics"])
    colors = ['#8EBAD9'] * (len(biologics_df) - 1) + ['#EB5E28']
    
    col1, col2 = st.columns([2, 1])
    with col1:
        fig1 = go.Figure()
        fig1.add_trace(go.Bar(x=biologics_df['period'], y=biologics_df['revenue'], name='ë§¤ì¶œì•¡(ì‹­ì–µ)', marker_color=colors, text=biologics_df['revenue'], textposition='auto'))
        fig1.add_trace(go.Scatter(x=biologics_df['period'], y=biologics_df['op_income'], name='ì˜ì—…ì´ìµ(ì‹­ì–µ)', mode='lines+markers+text', line=dict(color='#252422', width=3), text=biologics_df['op_income'], textposition='top center'))
        fig1.update_layout(title="ë¶„ê¸°ë³„ ë§¤ì¶œ ë° ì˜ì—…ì´ìµ ì¶”ì´", height=500)
        st.plotly_chart(fig1, use_container_width=True)
    with col2:
        st.subheader("ğŸ’¡ ì£¼ìš” ì¸ì‚¬ì´íŠ¸")
        st.info("4ê³µì¥ í’€ ê°€ë™ ë° ê³ ë¶€ê°€ê°€ì¹˜ ìˆ˜ì£¼ í™•ëŒ€ë¡œ ì‚¬ìƒ ìµœëŒ€ ë§¤ì¶œ ë‹¬ì„±.")

    st.divider()

    # ì‚¼ì„±ë°”ì´ì˜¤ì—í”¼ìŠ¤ ì„¹ì…˜
    st.header("ğŸ§¬ ì‚¼ì„±ë°”ì´ì˜¤ì—í”¼ìŠ¤ (Samsung Bioepis)")
    bioepis_df = pd.DataFrame(data["SamsungBioepis"])
    quarter_data = bioepis_df[bioepis_df['period'].str.contains('Q')]
    if not quarter_data.empty:
        fig2 = go.Figure()
        fig2.add_trace(go.Bar(x=quarter_data['period'], y=quarter_data['revenue'], name='ë§¤ì¶œì•¡(ì‹­ì–µ)', marker_color='#B7E4C7', text=quarter_data['revenue'], textposition='auto'))
        fig2.update_layout(title="ì‹¤ì  ì¶”ì´ (ë°”ì´ì˜¤ì‹œë°€ëŸ¬ ê¸€ë¡œë²Œ ì ìœ ìœ¨ í™•ëŒ€)", height=400)
        st.plotly_chart(fig2, use_container_width=True)

def show_ai_research_page():
    st.title("ğŸ”¬ AI ì—ì´ì „íŠ¸ ê°€ìƒ ì—°êµ¬ì†Œ ì „ëµ ëŒ€ì‹œë³´ë“œ")
    HISTORY_FILE = "ai_research_history.json"
    IMAGE_FILE = "virtual_lab_infographic_v1.png"
    
    if not os.path.exists(HISTORY_FILE):
        st.warning("ì•„ì§ ìˆ˜ì§‘ëœ ì—°êµ¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ì—ì„œ ìˆ˜ì§‘ê¸°ë¥¼ ê°€ë™í•´ì£¼ì„¸ìš”.")
        return

    with open(HISTORY_FILE, 'r', encoding='utf-8') as f:
        history = json.load(f)
    
    latest = history[-1]
    st.header(f"ğŸ–¼ï¸ ì´ë²ˆ ì£¼ í•µì‹¬ ì¸í¬ê·¸ë˜í”½ ({latest['date']})")
    
    # ì¸í¬ê·¸ë˜í”½ í‘œì‹œ (íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸)
    if os.path.exists(IMAGE_FILE):
        st.image(IMAGE_FILE, use_container_width=True, caption="AI ì—ì´ì „íŠ¸ í˜‘ì—… êµ¬ì¡° (Generated by AI)")
    else:
        st.info("ğŸ¨ ì¸í¬ê·¸ë˜í”½ ì´ë¯¸ì§€ë¥¼ ìƒì„± ì¤‘ì´ê±°ë‚˜ ê²½ë¡œë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤.")
    
    st.divider()
    st.header("ğŸ“‹ ìµœì‹  ë…¼ë¬¸ ë¶„ì„ & PPT ìŠ¬ë¼ì´ë“œ")
    st.markdown(latest['analysis'])
    
    st.divider()
    st.header("ğŸ“ NotebookLM Expert Source")
    st.download_button("NotebookLMìš© ì†ŒìŠ¤ ë‹¤ìš´ë¡œë“œ", latest['analysis'], file_name=f"notebook_source_{latest['date']}.txt")

def show_career_page():
    st.title("ğŸ“‚ ê°œì¸ ê²½ë ¥ ê´€ë¦¬ (Secret Mode)")
    st.success("ğŸ”“ ê´€ë¦¬ì ëª¨ë“œë¡œ ì ‘ì†í•˜ì…¨ìŠµë‹ˆë‹¤. ì´ ë©”ë‰´ëŠ” ë°•ì‚¬ë‹˜ê»˜ë§Œ ë³´ì…ë‹ˆë‹¤.")
    
    # ì‹¤ì œ ê²½ë ¥ ë°ì´í„° ë¡œë“œ ë¡œì§ (ìˆì„ ê²½ìš°)
    st.markdown("### ìµœì‹  ì´ì§ ê¸°íšŒ ìš”ì•½")
    if os.path.exists("seen_career_opportunities.json"):
        with open("seen_career_opportunities.json", "r", encoding="utf-8") as f:
            seen_jobs = json.load(f)
        st.write(f"í˜„ì¬ê¹Œì§€ {len(seen_jobs)}ê°œì˜ ì ì¬ì  ê¸°íšŒë¥¼ íƒìƒ‰í–ˆìŠµë‹ˆë‹¤.")
    
    st.write("2ì£¼ ë‹¨ìœ„ ìƒì„¸ ë¦¬í¬íŠ¸ëŠ” í…”ë ˆê·¸ë¨ì„ í†µí•´ ë°œì†¡ë©ë‹ˆë‹¤.")

# --- 3. ë¡œì§ ì‹¤í–‰ ---
if page == "ğŸ“Š ì‚¼ì„±ë°”ì´ì˜¤ ì‹¤ì  ë¶„ì„":
    show_samsung_page()
elif page == "ğŸ”¬ AI ê°€ìƒ ì—°êµ¬ì†Œ ë™í–¥":
    show_ai_research_page()
elif page == "ğŸ“‚ ê²½ë ¥ ëª¨ë‹ˆí„°ë§ (ë¹„ë°€)":
    show_career_page()

st.sidebar.markdown("---")
st.sidebar.caption(f"Last updated: {datetime.now().strftime('%Y-%m-%d')}")
